# レビュープロセスガイドライン

1. プルリクエスト作成後、作業途中でもいいので細かくレビュー依頼を出すよう心がけること
2. プルリクエストは少なくとも1名のレビュワーによる承認をすること

## レビュー時のチェックポイントやガイドライン

### コードの可読性
コードが理解しやすく、他の開発者が後でメンテナンスしやすいか確認すること。以下の点に注意しながらレビューすること。

1. 変数名・関数名が明確であるか確認すること  
   "data", "process" など、曖昧な名前ではなく、`userInputData` や `processPayment` など、何を扱っているのかを具体的に示す名前を使っているか確認すること。
2. 関数やメソッドの長さを確認すること  
   1つの関数やメソッドが複数の役割を担っていないか、役割毎に適切に分割されているかを確認すること。
3. コメントが適切に使用されているか確認すること  
   コメントの過剰利用、または不足がないか確認すること。コメントとコードの内容に食い違いはないか、コードそのものを説明している不要なコメントがないか確認すること。
4. 一貫したインデントとフォーマットが使用されているか確認すること  
   インデント幅が一貫しており、コードのブロック構造が視覚的に理解しやすくなっているか確認すること。行末のセミコロンやブレースの位置など、プロジェクトで定められたコーディングスタイルにしたがっているか確認すること。
5. 冗長なコードを削除すること  
   無駄に複雑な処理や、同じことを繰り返す処理がないか確認すること。同じことを繰り返すような場合は、共通の処理やモジュールに切り出して再利用制を検討すること。
6. エラーハンドリングが明確になっているか確認すること  
   エラーが発生した場合に、コードが適切に対処するようになっているか確認すること。エラーメッセージが分かりやすく、原因が特定しやすいか確認すること。
7. 条件分岐のシンプルになっているか確認すること  
   if,switch,case,unlessなど、各条件分岐が過度に複雑でないか確認すること。ネストが深すぎたり、多数のelse ifが並んでいる場合は、ロジックの簡素化を検討すること。
8. データ構造やアルゴリズムの適切な選択がされているか確認すること  
   検索処理に配列を使うよりも、ハッシュを使うなど、適切なデータ構造が使用されているか確認すること。
9. ハードコーディングされていないか確認する  
   ハードコードされた数字や文字列がコード内にないか確認すること。これらは定数や設定ファイルに分離し、コード内で何を意味しているのかが分かるようになっているか確認すること。
10. パフォーマンスを意識したコードになっているか確認すること  
    パフォーマンスに影響するような無駄なループや、DBから大量のレコードを取り出して計算する処理がないか確認すること。DBから取り出す際には、カーソル(ページネーション)を意識したコードを記載するよう検討すること。
11. 関数の呼び出し順序の確認  
    関数の呼び出し順序による依存関係がある場合、依存関係が分かるコーディングになっているか確認すること。

### コードの一貫性
プロジェクト全体のコーディングスタイルや規約に沿っているか確認すること。以下の点について

1. 命名規則の遵守  
   変数名・関数名・クラス名・ファイル名などがプロジェクトで定められた命名規則になっているか確認すること。例えば、キャメルケース(camelCase), スネークケース(snake_case)など、スタイルガイドに従って一貫性のあるコートになっているかなど、チェックすること。
2. コードのフォーマッティング  
   自動フォーマッタを適用して、一貫性のあるコーディングになっているか確認すること。
3. 関数・メソッドの構造  
   関数やメソッドの引数の順序、戻り値の型、エラーハンドリング方法が一貫しているか確認すること。エラーハンドリングは常に事前・事後で行うなど、統一されているか確認する。
4. コメントスタイル  
   コメントの書き方が一貫しているか確認すること。ドキュメンテーションコメント(`"/** */"`, `"///"`など)、ToDoコメントの記述方法、関数の説明やパラメータの説明の方法が統一されているかを確認すること。
5. コードの分割と配置  
   適切にモジュール化されており、ファイル・ディレクトリ構造が規約通りになっているか確認すること。
6. 使用するライブラリやフレームワークの一貫性  
   特定のライブラリやフレームワークがプロジェクトで標準として採用されている場合、それらが適切に使用されているか確認すること。例えば、状態管理はReduxを使う、非同期処理はasync/awaitを使うなど、一貫しているか確認すること。
7. エラーメッセージのフォーマット  
   エラーメッセージの文体や形式が一貫しているか確認すること。例えば、先頭が大文字で始まる、特定のフォーマットが使われているかなど確認をすること。
   ```
   例: error: ...Description...
   ```
8. テストコードの一貫性  
   テストの書き方やフレームワークの使い方がプロジェクト全体で統一されているか確認すること。例えば、テスト名の付け方や、テストデータのセットアップ方法、リソースの開放手順から、モックの使用方法まで一貫しているかチェックする。
9. プロジェクト固有のコーディング規約の確認  
   プロジェクト固有のルールがある場合、それらが遵守されているか確認すること。特定のAPIコールの順序、特定のファイルには必ずヘッダコメントを入れるなど、プロジェクト独自のルールに則っているか確認すること。  

### テストの有無
テストは、CircleCIやForgejo Runnerを使用して、なるべくCI/CDによる自動テストを実施すること。
この自動テストにより、新機能追加や機能変更などの際に、新たなバグを発見や、既存機能が壊れていないかなどの発見がやりやすくなる。

### セキュリティリスク
1. アップデートと依存関係の管理  
   * 新しい依存ライブラリやパッケージが追加された場合、それが適切であるか、セキュリティリスクがないか確認すること。信頼性やライセンス、脆弱性が含まれていないか、最新のバージョンになっている確認すること。
   * 既存のフレームワークのセキュリティパッチが含まれていないかなど、定期的にアップデートを確認すること。
2. 入力バリデーションの確認
   * サーバサイド・クライアント再度両方でのバリデーションを実施し、入力データが期待する形式、範囲、型に適合するか確認すること。
   * 無害化(サニタイズ)を実施し、インジェクション、XSS攻撃などのセキュリティリスクがないか確認すること。
3. 認証・認可の確認  
   * 管理者が特定の機能にアクセスできるように制限されているかなど、ユーザがアクセスできるリソースや操作が適切に制限されているかを確認すること。
   * セキュリティ要件に対して、"高"を求められる場合、パスワードがBcriptやArgon2などの強力なハッシュアルゴリズムにより、適切にハッシュ化されて保存されているか確認すること。
4. データの暗号化をしているか確認  
   重要なデータ(個人情報や支払い情報など)が適切に暗号化されているか確認すること。
5. エラーハンドリングとログメッセージの確認  
   エラーメッセージや、ログファイルに機密情報(パスワード・クレジットカード情報など)が記録されないようにしているか確認すること。ユーザに対しては一般的なメッセージのみを表示し、詳細なログはサーバ側にのみ保存するようにしているか確認すること。
6. CSRFの防止  
   フォームや重要な操作に対してCSRFトークンが適切に使用されているか確認すること。トークンがセッションに紐づいており、かつ一度しか使用できないことを確認すること。
7. CORSが適切に設定されているか確認  
   APIやWebアプリケーションがCORSポリシーを適切に設定しているか確認すること。許可するオリジン、ヘッダー、メソッドが適切に制限されているかを確認すること。
   ```
   Access-Control-Allow-Origin: https://frontend.example.com
   Access-Control-Allow-Methods: GET, POST, PUT, DELETE
   Access-Control-Allow-Headers: Content-Type, Authorization
   ```
8. セキュリティヘッダの設定  
   Webアプリケーション開発の場合は、以下のセキュリティヘッダが設定されているか確認すること。
   * X-Content-Type-Options  
     ブラウザがコンテンツのMIMEタイプを推測しないようにする。これにより、スクリプトインジェクション攻撃を防止する。
     ```go
     // Go言語での設定例
     w.Header().Set("X-Content-Type-Options", "nosniff")
     ```
   * X-Frame-Options  
     ページが`<iframe>`あぐで他のサイトに埋め込まれるのを防ぐ。これにより、クリックジャッキング攻撃を防止する。
     ```go
     // Go言語での設定例
     w.Header().Set("X-Frame-Options", "DENY")
     ```
   * Content Security Policy (CSP)  
     CSPは、Webページにどのリソース(スクリプト・CSS・画像・フォントなど)が読み込まれるかを、Webサーバがブラウザに対して指示するためのセキュリティ機能である。これにより、ハッキングを受け、意図しないスクリプトの実行や、許可されていないリソースのロードを防ぐことができるため、XSSなどの攻撃を防止する。
     ```go
     // Go言語での設定例
     w.Header().Set("Content-Security-Policy",
         "default-src 'self'; script-src 'self' https://trusted.cdn.com;")
     ```
9. タイムアウトとリクエストの制限をかけているか確認する  
   一定時間使用されていなかった場合、自動的にタイムアウトするか確認すること。また、ブルートフォースアタックを防ぐために、秒間最大リクエスト数などの制限を設けているか確認すること。

※想定以上のセキュリティリスクがありそうな場合は、外部のセキュリティ監査団体などに依頼する方法もあり。

### プルリクエストの確認
1. タイトルと内容があっているか確認すること
2. 機能的要求を満たしているか確認すること  
   プルリクエストに実装しようとしている機能や修正についてちゃんと記載されているか確認すること。
3. フィードバックを明確に行っているか確認すること  
   具体的に、何が問題かをはっきりさせ、どのように修正すべきかを示しているか確認すること。
4. ドキュメンテーションの更新がないか確認すること  
   プルリクエスト内に記載されている内容が、基本設計書や要件定義にも記載されているべきか確認すること。

### レビュー指摘方法
レビュー時の指摘は以下のルールを守り明確に行うこと。

1. 目的を明確にすること
   * 品質向上: 読みにくいコードであれば、読みやすくなる方法を提案するなど
   * バグの防止: 依存関係などが不十分でバグの発端になりそうな箇所は、修正方法を提案するなど
2. ポジティブなフィードバックを心掛ける
   * よく出来ている点については「この部分はいい実装ですね！」など、ポジティブなフィードバックを提供すること
3. 具体的で明確なコメントを書く
   * 「分かりにくいです」というコメントではなく、「関数名が抽象的です。目的は○○なので、関数名は△△である方が理解しやすいです」などの具体的な修正案を提示すること。
   * 必要に応じて、コードの例を示すことで、意図が伝わりやすくなる
4. 問題点の書き方
   * 「この変数名はなぜこのように命名されたのでしょうか？」など、質問形式で書くことで相手が説明しやすくなる
   * 「このコードは拡張性に問題があります。複数のユーザが同時にアクセスするとパフォーマンスが低下する可能性があるためです。」のように具体的な課題と影響範囲を指摘すること
5. 修正が必要な場合の指示  
   * 重大な問題と軽微な改善点を区別し、「この部分はセキュリティリスクがあるため、必ず修正が必要です。」のように優先度を明確にすること
   * 「このロジックは少し複雑なので、関数を分割して見やすくすることを検討してください。」といった代替案を提示すると、修正の方向性を明確にすること
6. コミュニケーションの配慮
   * 「このアプローチを選んだ理由を教えてもらえますか？」と尋ね、開発者の意図を理解し、必要な場合はディスカッションを通じて最適な解決策をチームで見つける取り組みをすること
   * レビューは相手の努力を否定するものではないので、「この部分について再考をお願いできますか？」といった、敬意を持った言葉遣いを心がけること
7. ドキュメントやテストの確認
   * 新機能や変更が適切にドキュメントに反映されているか確認すること
   * 新しい機能や修正に対するテストが適切に追加されているか、また既存のテストが変更に対応しているかを確認すること
8. 合意形成  
   * 「この部分を変更することをお勧めしますが、もし異なる意見があれば教えてください。」といった形で、相手の意見や状況を尊重し、相手の提案を受け入れる余地を残すこと
   * 大きな修正が必要であれば、「この問題について一緒に解決策を考えましょう」と協力して解決策を一緒に検討すること
9. レビューの一貫性  
   * 小さな変更でも頻繁にレビューを行い、大きな問題を未然に防ぐこと
   * チームで合意したコーディングスタイルガイドに従い、スタイルの統一性を保つこと
